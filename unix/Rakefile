#!/usr/bin/ruby

require 'pp'
require 'fileutils'
include FileUtils
require 'erb'
require 'rake/testtask'
require 'matrix'

desc 'Check git'
task :git do 
  sh "git diff --exit-code --quiet" do |ok,res|
    if !ok
      sh "git status"
#      fail "Uncommited local changes, please fix with 'git add' etc."
    end
  end
end

desc 'Create html doc from xml'
file 'lang/yabasic.htm' => 'doc/yabasic.xml' do
  ENV['SGML_CATALOG_FILES']='/etc/xml/catalog'
  sh 'xsltproc doc/mystyle.xsl doc/yabasic.xml >lang/yabasic.htm'
end

desc 'Create man page'
file 'lang/yabasic.1' => 'doc/yabasic.htm' do
  ascii=%x{ w3m -dump -o display_charset=ascii,cols=74 yabasic.htm >/tmp/y.utf8 }
  fail if $?.exitstatus
  open('doc/yabasic.1','w') {|f| f.write ERB.new(File.new('doc/yabasic.1.erb').read).result}
end

desc 'Create configure'
file 'lang/configure' => 'lang/configure.ac' do
  cd ('lang') { sh 'autoconf' }
end

desc 'Create Makefile.in'
file 'lang/Makefile.in' => 'lang/Makefile.am' do
  cd ('lang') { sh 'automake' }
end

desc 'Create Makefile'
file 'lang/Makefile' => ['lang/Makefile.in','lang/configure'] do
  cd ('lang') {
    sh 'configure'
    sh 'config.status'
  }
end

desc 'Run make'
task :make do
  cd ('lang') { sh 'make' }
end

vs=Hash.new
desc 'Collect Versions'
task :versions => [:git,'lang/yabasic.htm',:make,'lang/Makefile','lang/configure'] do
  vs['yabasic']=%x( lang/yabasic -v 2>&1 ).match(/yabasic (\d\.\d+\.\d+)/ )[1]
  vs['configure.ac']=File.new('lang/configure.ac').read.match(/AC_INIT\(\[yabasic\],\s+\[(\d\.\d+\.\d+)\]\)/)[1]
  vs['yabasic.htm']=File.new('lang/yabasic.htm').read.match(/version\s+(\d\.\d+\.\d+)/)[1]
  pp vs
  fail "Mismatch" unless (vs['yabasic'].gsub(/\.\d+$/,"").to_f-vs['yabasic.htm'].gsub(/\.\d+$/,"").to_f).abs<0.01 && vs['yabasic']==vs['configure.ac']
end

desc 'Create tar with sources'
task :sources => :versions do
  cd 'lang' do
    sh 'make dist-gzip'
    mv "yabasic-#{vs['yabasic']}.tar.gz", '../../products'
  end
end
  
desc 'Create rpm'
task :rpm => :versions do
  cd "lang" do
    sh 'make install DESTDIR=pkg'
    ydir = 'pkg/usr/local/share/applications/yabasic'
    mkdir_p ydir
    %w( demo.yab yabasic.htm ).each do |file|
      cp file, ydir
    end
    %w( rpm deb ).each do |fmt|
      sh "fpm -f -s dir -t #{fmt} -n yabasic -v #{vs['yabasic']} -C pkg"
    end
    mv "yabasic-#{vs['yabasic']}-1.x86_64.rpm",'../../products'
    mv "yabasic_#{vs['yabasic']}_amd64.deb",'../../products'
  end
end

def compare_semver one,two
  vers = [one, two].map do |x|
    md = x.match(/(\d+)\.(\d+)\.(\d+)/)
    fail "Argument '#{x}' does not contain a semantic version number" unless md
    [md[1],md[2],md[3]]
  end.transpose

  vers.inject(0) {|s,x| 2*s+(x[0]<=>x[1])} <=> 0
end

def cleanup glob
  Dir[glob].sort {|x,y| compare_semver x,y }[0..-2].each {|x| puts "==== rm #{x}"}
end

desc 'Cleanup, sync and show products'
task :default => [:rpm, :sources] do
  prod_globs = %w( yabasic*.x86_64.rpm yabasic*amd64.deb yabasic*.tar.gz )
  prod_globs.each { |glob| cleanup "../products/#{glob}" }
  sync_dest = '/work/yabasic/products'
  if File.directory?(sync_dest)
    Dir['../products/*'].each do |p|
      cp p, sync_dest
    end
    prod_globs.each { |glob| cleanup sync_dest+"/"+glob }
    cp 'lang/yabasic.htm', sync_dest
    sh "ls -l #{sync_dest}"
  else
    puts "Sync destination #{sync_dest} not present !"
  end
end

