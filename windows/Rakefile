#!/usr/bin/ruby

require 'pp'
require 'fileutils'
include FileUtils
require 'erb'

start_time = Time.now
binaries = {:lang => 'lang/Release/yabasic.exe', :setup => 'setup/Release/setup.exe', :wrapper => 'wrapper/Release/wrapper.exe' }

desc 'Check git'
task :git do 
  sh "/usr/bin/git diff --exit-code --quiet" do |ok,res|
    if !ok
      sh "git status"
      warn "Uncommited local changes, please fix with 'git add' etc."
    end
  end
end

desc 'Build yabasic'
task :build => :git do
  binaries.each do |key,bin|
    vcxproj = {:lang => 'yabasic', :setup => 'setup', :wrapper => 'wrapper' }
    rm bin if File.exist?(bin)
    sh '/cygdrive/c/Program Files (x86)/MSBuild/14.0/Bin/MSBuild.exe',
       "c:/work/yabasic/windows/#{key.to_s}/#{vcxproj[key]}.vcxproj",
       '/p:Configuration=Release'
    fail "File '#{bin}' has not been build" if File.mtime(bin) < start_time
  end
end

version = nil
desc 'Collect Versions'
task :versions => :build do
  File.open('version.yab','w') { |f| f.puts 'open 1,"yabasic.version","w":print #1 peek$("version"):close 1:exit' }
  sh 'cygstart --wait ./lang/Release/yabasic.exe version.yab'
  version=File.new('yabasic.version').read.chomp.strip
  puts "Version = " + version
end

desc 'Pack binaries'
task :pack => :versions do
  cp '../unix/lang/LICENSE', '/cygdrive/c/Windows/Temp/LICENSE.txt'
  File.open('yabasic-setup.SED','w') do |file|
    file.write ERB.new(File.read('resources/yabasic-setup.SED.erb')).result(binding)
  end
  File.open('resources/yabver.txt','w') { |f| f.puts version }
  sh 'iexpress /N yabasic-setup.SED'
end

def compare_semver one,two
  vers = [one, two].map do |x|
    md = x.match(/(\d+)\.(\d+)\.(\d+)/)
    fail "Argument '#{x}' does not contain a semantic version number" unless md
    [md[1],md[2],md[3]]
  end.transpose

  vers.inject(0) {|s,x| 2*s+(x[0]<=>x[1])} <=> 0
end

def cleanup glob
  Dir[glob].sort {|x,y| compare_semver x,y }[0..-2].each {|x| rm x}
end

desc 'Cleanup and Show products'
task :default => :pack do
  cleanup "../products/yabasic-*-setup.exe"
  sh 'ls -l ../products ' + binaries.values.join(" ")
end
